{% extends 'core/index.html' %}
{% load static %}
{% block title %}Hilo{% endblock %}
{% block content %}
<style>
  .avatar  { width:50px; height:50px; float:left; margin-right:10px; }
  .thread  { max-height:300px; overflow-y:auto; padding:0 0.5em;} 
  .mine    { padding:0 0.5em 0.25em; background-color:rgba(230,242,245,.5); width:92%; margin-left:8%; }
  .other   { padding:0 0.5em 0.25em; background-color:#f2f3f5; width:92%; }
</style>
<main role="main">
  <div class="container">
    <div class="row mt-3">
      <div class="col-md-9 mx-auto mb-5">
        <div class="row">
          <!--conversation threads -->
          <div class="col-md-4">
            <!-- Reverse search user.threads we can also get the threads of a user -->
            {% for thread in request.user.thread.all %}
              <!-- Only show a Thread if you have at least 1 message-->
              {% if thread.messages.all|length > 0 %}
                <div class="mb-3">
                  <!-- We loop the thread members excepts request.user-->
                  {% for user in thread.users.all %}
                    {% if user != request.user %}     
                      <!-- Show avatar of user-->                
                      {% if user.profile.avatar %}
                        <img src="{{user.profile.avatar.url}}" class="avatar">
                      {% else %}
                        <img src="{% static 'registration/img/no-avatar.jpg' %}" class="avatar">
                      {% endif %}
                      <!-- Show information menber --> 
                      <div>
                        <a href="{% url 'messenger:detail' thread.pk %}">{{user}}</a><br>
                        <small><i>Hace {{thread.messages.last.created|timesince}}</i></small>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
          <!-- combersation thread  -->
          <div class="col-md-8">
            <!-- We loop through the thread members minus the request.user itself  -->
            {% for user in thread.users.all %}
              {% if user != request.user %}       
                <h4 class="mb-4">Mensajes con <a href="{% url 'profiles:detail' user %} ">{{user}}</a></h4>
              {% endif %}
            {% endfor %}
            <!-- Show the menssages in label overflow vertical of  300 píxeles -->
            <div class="thread" id="thread">
              {% for message in object.messages.all %}
                <!-- Depending on the user, we assign a class with a background color or another in the message -->
                <div {% if request.user == message.user %}class="mine mb-3"{% else %}class="other mb-3"{% endif %}>
                  <small><i>Hace {{thread.messages.last.created|timesince}}</i></small><br>
                  {{message.content}}
                </div>
              {% endfor %}
            </div>
            <!-- Create form here -->
            <textarea class='form-control mb-2' id="content" rows="2" placeholder="Write your message here"></textarea>

            <button id="send" class="btn btn-secondary btn-sm btn-block" disabled>Peticion asincrona de prueba</button>
            <script>
              var send = document.getElementById("send");
              send.addEventListener('click', function(){
                var content = encodeURIComponent(document.getElementById("content").value);
                if (content.length > 0){
                const url = "{% url 'messenger:add' thread.pk %}"+"?content="+content;
                fetch(url, {'credentials':'include'}).then(response => response.json()).then(function(data){
                // If message created correctly
                if (data.created) {
                var message = document.createElement('div');
                message.classList.add('mine','mb-3');
                message.innerHTML = '<small><i>Hace unos segundo</i></small><br>'+decodeURIComponent(content);
                document.getElementById('thread').appendChild(message);
                ScrollBottomInThread();               
                } else {
                
                // Debugg
                console.log("Algo ha fallado y el mensaje no se ha podido añadir.")
                })
                }
              })

              //Button activated if there is a message.
              var content = document.getElementById("content");
              content.addEventListener("keyup", function(){
                if (!this.checkValidity() || !this.value){
                  send.disabled = true;
                } else {
                  send.disabled = false;
                }
              })

              function ScrollBottonInThread(){
                var thread = document.getElementById("thread");
                thread.scrollTop = thread.scrollHeight;
              }
              ScrollBottomInThread();
            </script>  
          </div>
        </div>
    </div>
  </div>
</main>
{% endblock %}